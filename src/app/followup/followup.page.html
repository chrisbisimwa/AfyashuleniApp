
<ion-header class="ion-no-border" mode="ios">
  <ion-toolbar style="--background: var(--ion-color-primary)">
    <ion-title style="color: white; letter-spacing: 1px; font-family: 'semi-bold';">Suivi des examens</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="main_content_div">
    <ion-label class="title_lbl">Suivi des élèves</ion-label>

    <!-- Sélection de l'école -->
    <ion-list>
      <ion-item>
        <ion-label position="stacked">Type de suivi</ion-label>
        <ion-select [(ngModel)]="followUpsType" placeholder="Sélectionnez un type de suivi">
          <ion-select-option value="first_followup">Premier suivi</ion-select-option>
          <ion-select-option value="second_followup">Deuxième suivi</ion-select-option>
        </ion-select>
      </ion-item>
      <ion-item *ngIf="followUpsType">
        <ion-label position="stacked">École</ion-label>
        <ion-select [(ngModel)]="selectedSchool" (ionChange)="fetchClasses($event)" placeholder="Sélectionnez une école">
          <ion-select-option *ngFor="let school of schools" [value]="school.id">
            {{ school.name }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <!-- Sélection de la classe -->
      <ion-item *ngIf="selectedSchool">
        <ion-label position="stacked">Classe</ion-label>
        <ion-select [(ngModel)]="selectedClasse" (ionChange)="fetchStudents($event)" placeholder="Sélectionnez une classe">
          <ion-select-option *ngFor="let classe of classes" [value]="classe.id">
            {{ classe.name }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <!-- Recherche et sélection de l'élève -->
      <ion-item *ngIf="selectedClasse">
        <ion-label position="stacked">Rechercher un élève</ion-label>
        <ion-searchbar [(ngModel)]="searchQuery" (ionInput)="filterStudents()" placeholder="Rechercher par nom ou prénom" debounce="300"></ion-searchbar>
      </ion-item>

      <!-- Liste des élèves filtrés -->
      <ion-list *ngIf="selectedClasse && filteredStudents.length > 0">
        <ion-item *ngFor="let student of filteredStudents" (click)="selectStudent(student)">
          <ion-label [class.selected]="selectedStudent?.id === student.id">
            {{ student.first_name }} {{ student.last_name }} {{student.surname}} 
          </ion-label>
        </ion-item>
      </ion-list>

      <!-- Message si aucun élève n'est trouvé -->
      <ion-item *ngIf="selectedClasse && filteredStudents.length === 0 && searchQuery">
        <ion-label>Aucun élève trouvé pour "{{ searchQuery }}"</ion-label>
      </ion-item>
    </ion-list>

    <!-- Liste des problèmes identifiés pour l'élève -->
    <ion-item-group *ngIf="evaluations.length > 0">
      <ion-item-divider>
        <ion-label>Problèmes identifiés ({{ evaluations.length }})</ion-label>
      </ion-item-divider>
      <ion-item *ngFor="let evaluation of evaluations; let i = index">
        <ion-label>
          <h2>{{ evaluation.problemName }}</h2>
          <p>Date de l'examen : {{ evaluation.examDate | date:'mediumDate' }}</p>
          <p>Évaluation initiale : {{ getEvaluationLabel(evaluation.status) }}</p>
          <p>Statut actuel : {{ getFollowUpStatusLabel(followUpStatuses[i]) }}</p>
        </ion-label>
        <ion-select slot="end" [(ngModel)]="followUpStatuses[i]" (ionChange)="updateFollowUpStatus(i, $event.detail.value)" placeholder="Statut du suivi">
          <ion-select-option value="fully_solved">Solutionné</ion-select-option>
          <ion-select-option value="partially_solved">Partiellement solutionné</ion-select-option>
          <ion-select-option value="not_solved">Non solutionné</ion-select-option>
        </ion-select>
      </ion-item>
    </ion-item-group>

    <!-- Bouton pour enregistrer le suivi -->
    <ion-button *ngIf="evaluations.length > 0" expand="block" color="primary" (click)="saveFollowUp()">
      Enregistrer le suivi
    </ion-button>
  </div>
</ion-content>